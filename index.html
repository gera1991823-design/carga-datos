<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos - Interagrovial</title>

 <style>
  :root{
    /* Interagrovial dark (verde/amarillo) */
    --green:#3a5f32;           /* botón verde (tipo captura) */
    --green-2:#2f4f2a;
    --yellow:#c9bf4a;          /* línea amarilla */
    --yellow-2:#d7cf62;

    --bg:#0f1012;              /* fondo general */
    --panel:#141518;           /* card */
    --panel-2:#101114;         /* variación */
    --text:#e7e9ee;            /* texto principal */
    --muted:#a6adb8;           /* texto secundario */

    --border:rgba(255,255,255,.08);
    --border-2:rgba(255,255,255,.12);

    --shadow: 0 18px 45px rgba(0,0,0,.55);
    --shadow2: 0 8px 22px rgba(0,0,0,.45);

    --radius:18px;

    --focus: 0 0 0 4px rgba(58,95,50,.30);
  }

  *{box-sizing:border-box}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 22px;
    background: radial-gradient(1200px 700px at 20% -10%, rgba(58,95,50,.25), transparent 60%),
                radial-gradient(900px 600px at 110% 10%, rgba(201,191,74,.12), transparent 55%),
                var(--bg);
    color: var(--text);
  }

  /* TOP */
  .topbar{
    display:flex;align-items:center;justify-content:space-between;
    gap:14px;flex-wrap:wrap;margin-bottom:14px;
  }
  .title{
    display:flex;align-items:center;gap:12px;margin:0;
    font-size:22px;font-weight:900;letter-spacing:.2px;
  }
  .brandDot{
    width:14px;height:14px;border-radius:999px;
    background: var(--green);
    box-shadow: inset 0 0 0 3px rgba(201,191,74,.95);
  }
  .subpill{
    display:inline-flex;align-items:center;gap:10px;
    border:1px solid var(--border);
    padding:8px 12px;border-radius:999px;
    background: rgba(20,21,24,.75);
    font-size:12px;color: var(--muted);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(6px);
  }
  .subpill b{color: var(--green)}

  /* CARDS */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)),
                var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    margin-bottom: 14px;
    overflow:hidden;
  }
  .accentBar{
    height:4px;border-radius:999px;
    background: linear-gradient(90deg, var(--green), var(--yellow));
    margin:-16px -16px 14px -16px;
    opacity:.95;
  }
  .card h3{
    margin:0 0 10px;font-size:13px;
    text-transform:uppercase;letter-spacing:.10em;
    color:#cfd5df;
  }
  .cardHeader{
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;flex-wrap:wrap;margin-bottom:10px;
  }

  .row{
    display:flex;gap:10px;flex-wrap:wrap;align-items:end;
  }
  label{
    font-size:12px;color:#cfd5df;display:block;margin-bottom:6px;font-weight:800;
  }

  /* INPUTS */
  input,select{
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:14px;
    font-size:14px;
    min-width:160px;
    background: rgba(16,17,20,.9);
    color: var(--text);
    outline:none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  input::placeholder{color: rgba(231,233,238,.45)}
  input:focus,select:focus{
    border-color: rgba(201,191,74,.35);
    box-shadow: var(--focus);
  }
  input[type="date"]{min-width:170px;color-scheme:dark;} /* para datepicker dark */

  /* BUTTONS */
  button{
    padding:10px 14px;
    border:1px solid var(--border);
    background: rgba(20,21,24,.9);
    color: var(--text);
    border-radius:14px;
    cursor:pointer;
    transition: transform .12s ease, filter .12s ease, background .12s ease;
    font-weight:900;
    box-shadow: var(--shadow2);
  }
  button:hover{transform: translateY(-1px)}
  button.primary{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10)),
                var(--green);
    border-color: rgba(58,95,50,.9);
    color:#f2f6ef;
  }
  button.primary:hover{filter:brightness(1.03)}
  button.secondary{
    border-color: var(--border);
    background: rgba(20,21,24,.85);
    color:#d8dde6;
  }
  button.secondary:hover{filter:brightness(1.04)}
  button.danger{
    color:#ffb4b4;
    border-color: rgba(255,102,102,.28);
    background: rgba(60,16,16,.35);
  }
  button.small{
    padding:7px 10px;border-radius:12px;font-size:12px;
    box-shadow:none;font-weight:900;
  }
  button[disabled]{opacity:.6;cursor:not-allowed;transform:none}

  .muted{color:var(--muted);font-size:12px;margin-top:8px}
  .toast{
    margin-top:10px;font-size:13px;color: var(--yellow-2);
    display:none;font-weight:900;
  }
  .toast.err{color:#ff8f8f}

  /* TABLE */
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)),
                var(--panel);
    border:1px solid var(--border);
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
  }
  thead th{
    position:sticky;top:0;z-index:2;
    background: rgba(20,21,24,.92);
    text-align:center;
  }
  th,td{
    border-bottom:1px solid rgba(255,255,255,.06);
    padding:10px;
    font-size:14px;
    vertical-align:top;
    white-space:nowrap;
    text-align:center;
    color: var(--text);
  }
  th{
    font-size:12px;letter-spacing:.10em;text-transform:uppercase;
    color:#cfd5df;position:relative;
  }
  th::after{
    content:"";
    position:absolute;left:0;bottom:0;width:100%;height:3px;
    background: linear-gradient(90deg, var(--green), var(--yellow));
    opacity:.95;
  }
  tbody tr:nth-child(odd){background: rgba(255,255,255,.015)}
  tbody tr:hover{background: rgba(58,95,50,.14)}

  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

  .cell-input{
    min-width:120px;
    padding:7px 10px;border-radius:12px;
    border:1px solid var(--border);
    background: rgba(16,17,20,.92);
    color: var(--text);
    text-align:center;
  }

  /* widths */
  .w220{min-width:220px}
  .w200{min-width:200px}
  .w160{min-width:160px}
  .w140{min-width:140px}
  .w110{min-width:110px}

  /* FOOTER */
  .footer{
    position:fixed;left:16px;bottom:12px;font-size:12px;
    color: var(--text);
    background: rgba(20,21,24,.75);
    border:1px solid var(--border);
    border-left:7px solid var(--green);
    padding:9px 12px;border-radius:14px;
    box-shadow: var(--shadow2);
    backdrop-filter: blur(6px);
  }
  .footer b{color: var(--green)}

  /* Extra: mejora sutil de los select (flecha) en dark */
  select{
    appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(231,233,238,.65) 50%),
      linear-gradient(135deg, rgba(231,233,238,.65) 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 18px) calc(50% - 3px),
      calc(100% - 13px) calc(50% - 3px),
      calc(100% - 2.2rem) 0.45rem;
    background-size:5px 5px, 5px 5px, 1px 1.8rem;
    background-repeat:no-repeat;
    padding-right:34px;
  }
</style>

</head>

<body>

  <div class="topbar">
    <h1 class="title"><span class="brandDot"></span> Carga de datos</h1>
    <div class="subpill">Sistema <b>Interagrovial</b> · verde/amarillo</div>
  </div>

  <!-- FILTROS + EXPORT -->
  <div class="card">
    <div class="accentBar"></div>
    <div class="cardHeader">
      <h3>Filtros</h3>
      <div class="row" style="gap:8px">
        <button id="exportBtn" class="primary" type="button">Descargar Excel</button>
        <button id="clearFiltersBtn" class="secondary" type="button">Limpiar filtros</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Buscar (cualquier campo)</label>
        <input id="q" class="w220" placeholder="Ej: 12004566 / AGRO / 88855"/>
      </div>

      <div>
        <label>División</label>
        <select id="fDivision">
          <option value="">(Todas)</option>
        </select>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="fCond">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="fWis">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Fecha estimada desde</label>
        <input id="fDateFrom" type="date"/>
      </div>

      <div>
        <label>Fecha estimada hasta</label>
        <input id="fDateTo" type="date"/>
      </div>
    </div>

    <div class="muted">Los filtros se aplican automáticamente sobre la tabla. “Descargar Excel” exporta lo que estás viendo (con filtros).</div>
  </div>

  <!-- FORMULARIO AGREGAR -->
  <div class="card">
    <div class="accentBar"></div>
    <h3>Agregar fila</h3>

    <div class="row">
      <div>
        <label>Factura</label>
        <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
      </div>

      <div>
        <label>División</label>
        <input id="division" class="w200" placeholder="Ej: AGRO"/>
      </div>

      <div>
        <label>Transporte</label>
        <input id="transporte" class="w200" placeholder="Ej: Barco / Avión"/>
      </div>

      <div>
        <label>Carpeta</label>
        <input id="carpeta" class="w140" placeholder="Ej: 88855"/>
      </div>

      <div>
        <label>Fecha estimada</label>
        <input id="fecha_estimada" type="date" />
      </div>

      <div>
        <label>Orden de compra</label>
        <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="cond">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="wis">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <button id="addBtn" class="primary" type="button">Agregar</button>
    </div>

    <div id="msg" class="muted"></div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>Fecha carga</th>
        <th>Factura</th>
        <th>División</th>
        <th>Transporte</th>
        <th>Carpeta</th>
        <th>Fecha estimada</th>
        <th>Orden compra</th>
        <th>Condiciones</th>
        <th>WIS</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer"><b>INTERAGROVIAL S.A</b></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ PEGÁ ACÁ TU CONFIG REAL (la que ya te funciona)
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDIgNEkvCng0XrqGvDAuutCBSglodO3644",
  authDomain: "carpetas-17846.firebaseapp.com",
  projectId: "carpetas-17846",
  storageBucket: "carpetas-17846.firebasestorage.app",
  messagingSenderId: "513234224676",
  appId: "1:513234224676:web:0461b1fbfcea43deb5bab1",
  measurementId: "G-NRPLGK20YK"
};


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const tbody = $("tbody");
    const msgEl = $("msg");
    const toastEl = $("toast");
    const addBtn = $("addBtn");

    let editingRowId = null;
    let cache = [];
    let view = [];

    function showToast(text, isError=false){
      toastEl.textContent = text;
      toastEl.classList.toggle("err", isError);
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 2500);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function clearAddForm() {
      $("factura").value = "";
      $("division").value = "";
      $("transporte").value = "";
      $("carpeta").value = "";
      $("fecha_estimada").value = "";
      $("oc").value = "";
      $("cond").value = "SI";
      $("wis").value = "SI";
    }

    function withTimeout(promise, ms, timeoutMsg="Tiempo de espera agotado") {
      let t;
      const timeout = new Promise((_, rej) => { t = setTimeout(() => rej(new Error(timeoutMsg)), ms); });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    // ---- Filtros ----
    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

    function matchesText(row, q){
      if (!q) return true;
      const hay = [
        row.factura, row.division, row.transporte, row.carpeta,
        row.fecha_estimada, row.oc, row.cond, row.wis
      ].map(norm).join(" | ");
      return hay.includes(q);
    }

    function inDateRange(row, from, to){
      const d = row.fecha_estimada || "";
      if (!from && !to) return true;
      if (!d) return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function applyFilters(){
      const q = norm($("q").value);
      const fDivision = $("fDivision").value;
      const fCond = $("fCond").value;
      const fWis = $("fWis").value;
      const from = $("fDateFrom").value || "";
      const to = $("fDateTo").value || "";

      view = cache.filter(x => {
        const r = x.data;
        if (fDivision && (r.division || "") !== fDivision) return false;
        if (fCond && (r.cond || "") !== fCond) return false;
        if (fWis && (r.wis || "") !== fWis) return false;
        if (!matchesText(r, q)) return false;
        if (!inDateRange(r, from, to)) return false;
        return true;
      });

      draw();
    }

    function rebuildDivisionOptions(){
      const sel = $("fDivision");
      const current = sel.value;
      const values = Array.from(new Set(cache.map(x => (x.data.division || "").trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">(Todas)</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      if (values.includes(current)) sel.value = current;
    }

    ["q","fDivision","fCond","fWis","fDateFrom","fDateTo"].forEach(id=>{
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("clearFiltersBtn").addEventListener("click", ()=>{
      $("q").value = "";
      $("fDivision").value = "";
      $("fCond").value = "";
      $("fWis").value = "";
      $("fDateFrom").value = "";
      $("fDateTo").value = "";
      applyFilters();
    });

    // ---- Export (CSV -> Excel) ----
    function csvEscape(value){
      const s = (value ?? "").toString();
      const mustQuote = /[",\n\r;]/.test(s);
      const escaped = s.replaceAll('"','""');
      return mustQuote ? `"${escaped}"` : escaped;
    }

    function toCsv(rows){
      const headers = [
        "Fecha carga","Factura","División","Transporte","Carpeta",
        "Fecha estimada","Orden compra","Condiciones","WIS"
      ];
      const lines = [headers.map(csvEscape).join(",")];

      rows.forEach(x=>{
        const r = x.data;
        const dt = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "";
        const line = [
          dt,
          r.factura || "",
          r.division || "",
          r.transporte || "",
          r.carpeta || "",
          r.fecha_estimada || "",
          r.oc || "",
          r.cond || "",
          r.wis || ""
        ].map(csvEscape).join(",");
        lines.push(line);
      });

      return lines.join("\n");
    }

    function downloadCsv(filename, csv){
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("exportBtn").addEventListener("click", ()=>{
      const rows = (view.length ? view : cache);
      const csv = toCsv(rows);
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
      downloadCsv(`interagrovial_carga_${stamp}.csv`, csv);
      showToast("Descarga lista (CSV para Excel)");
    });

    // ---- CRUD ----
    addBtn.addEventListener("click", async () => {
      const data = {
        factura: $("factura").value.trim(),
        division: $("division").value.trim(),
        transporte: $("transporte").value.trim(),
        carpeta: $("carpeta").value.trim(),
        fecha_estimada: $("fecha_estimada").value || "",
        oc: $("oc").value.trim(),
        cond: $("cond").value,
        wis: $("wis").value,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const empty =
        !data.factura && !data.division && !data.transporte && !data.carpeta &&
        !data.fecha_estimada && !data.oc;

      if (empty) { alert("Ingresá al menos un dato para agregar."); return; }

      try {
        msgEl.textContent = "Guardando...";
        addBtn.disabled = true;
        await withTimeout(addDoc(collection(db, "rows"), data), 15000);
        msgEl.textContent = "";
        clearAddForm();
        showToast("Agregado con éxito");
      } catch (e) {
        console.error(e);
        msgEl.textContent = "";
        showToast("No se pudo guardar", true);
        alert("No se pudo guardar. Revisá reglas/permisos o la red.");
      } finally {
        addBtn.disabled = false;
      }
    });

    function renderRow(id, r) {
      const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      const dtTxt = dt ? dt.toLocaleString() : "";
      const isEditing = (editingRowId === id);

      if (!isEditing) {
        return `
          <tr data-id="${id}">
            <td>${escapeHtml(dtTxt)}</td>
            <td>${escapeHtml(r.factura)}</td>
            <td>${escapeHtml(r.division)}</td>
            <td>${escapeHtml(r.transporte)}</td>
            <td>${escapeHtml(r.carpeta)}</td>
            <td>${escapeHtml(r.fecha_estimada)}</td>
            <td>${escapeHtml(r.oc)}</td>
            <td>${escapeHtml(r.cond)}</td>
            <td>${escapeHtml(r.wis)}</td>
            <td>
              <div class="actions">
                <button class="small secondary" data-action="edit">Editar</button>
                <button class="small danger" data-action="delete">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }

      const factura = escapeHtml(r.factura || "");
      const division = escapeHtml(r.division || "");
      const transporte = escapeHtml(r.transporte || "");
      const carpeta = escapeHtml(r.carpeta || "");
      const fecha_estimada = escapeHtml(r.fecha_estimada || "");
      const oc = escapeHtml(r.oc || "");
      const cond = r.cond || "SI";
      const wis = r.wis || "SI";

      return `
        <tr data-id="${id}">
          <td>${escapeHtml(dtTxt)}</td>

          <td><input class="cell-input w140" data-field="factura" value="${factura}"></td>
          <td><input class="cell-input w200" data-field="division" value="${division}"></td>
          <td><input class="cell-input w200" data-field="transporte" value="${transporte}"></td>
          <td><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></td>
          <td><input class="cell-input w160" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></td>
          <td><input class="cell-input w140" data-field="oc" value="${oc}"></td>

          <td>
            <select class="cell-input w110" data-field="cond">
              <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <select class="cell-input w110" data-field="wis">
              <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <div class="actions">
              <button class="small primary" data-action="save">Guardar</button>
              <button class="small" data-action="cancel">Cancelar</button>
              <button class="small danger" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    function draw() {
      const dataToDraw = (view.length ? view : cache);
      tbody.innerHTML = dataToDraw.map(x => renderRow(x.id, x.data)).join("");
    }

    // Listener tiempo real
    const qSnap = query(collection(db, "rows"), orderBy("createdAt", "desc"));
    onSnapshot(qSnap, (snap) => {
      cache = [];
      snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
      rebuildDivisionOptions();
      applyFilters();
    }, (err) => {
      console.error(err);
      showToast("No se pudo leer Firestore", true);
    });

    // Acciones tabla
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit") { editingRowId = id; draw(); return; }
      if (action === "cancel") { editingRowId = null; draw(); return; }

      if (action === "save") {
        const fields = tr.querySelectorAll("[data-field]");
        const updated = {};
        fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());
        updated.cond = updated.cond === "NO" ? "NO" : "SI";
        updated.wis  = updated.wis  === "NO" ? "NO" : "SI";

        const empty =
          !updated.factura && !updated.division && !updated.transporte && !updated.carpeta &&
          !updated.fecha_estimada && !updated.oc;

        if (empty) { alert("La fila no puede quedar vacía."); return; }

        try {
          btn.disabled = true;
          await withTimeout(updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() }), 15000);
          editingRowId = null;
          showToast("Modificado con éxito");
          applyFilters();
        } catch (err) {
          console.error(err);
          showToast("No se pudo modificar", true);
          alert("No se pudo modificar. Revisá reglas/permisos o red.");
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delete") {
        if (!confirm("¿Seguro que querés eliminar esta fila?")) return;
        try {
          btn.disabled = true;
          await withTimeout(deleteDoc(doc(db, "rows", id)), 15000);
          if (editingRowId === id) editingRowId = null;
          showToast("Eliminado con éxito");
        } catch (err) {
          console.error(err);
          showToast("No se pudo eliminar", true);
          alert("No se pudo eliminar. Revisá reglas/permisos o red.");
        } finally {
          btn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>



