<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos - Interagrovial</title>

  <style>
    :root{
      --jd-green:#367c2b;
      --jd-yellow:#ffde00;

      --bg:#0b0b0d;
      --text:#e7e7ea;
      --muted:#a5a7b3;

      --border:#2a2d35;
      --border-strong:#3a3f4a;

      --shadow:0 18px 45px rgba(0,0,0,.55);
      --shadow2:0 8px 22px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 22px;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(54,124,43,.16), transparent 55%),
                  radial-gradient(1200px 600px at 85% 0%, rgba(255,222,0,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:14px;flex-wrap:wrap;margin-bottom:14px;
    }
    .title{
      display:flex;align-items:center;gap:12px;margin:0;
      font-size:22px;font-weight:900;letter-spacing:.2px;
    }
    .brandDot{
      width:14px;height:14px;border-radius:999px;
      background: var(--jd-green);
      box-shadow: inset 0 0 0 3px var(--jd-yellow);
    }
    .subpill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      font-size:12px;color:#cfd1da;
      box-shadow: var(--shadow2);
    }
    .subpill b{color:var(--jd-green)}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      overflow:hidden;
    }
    .accentBar{
      height:5px;border-radius:999px;
      background: linear-gradient(90deg, rgba(54,124,43,.95), rgba(255,222,0,.75));
      margin:-16px -16px 14px -16px;
      filter: saturate(1.05);
    }
    .cardHeader{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom:10px;
    }
    .card h3{
      margin:0 0 10px;font-size:13px;
      text-transform:uppercase;letter-spacing:.10em;
      color:#d6d7df;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:#cfd1da;display:block;margin-bottom:6px;font-weight:800}

    input,select{
      padding:10px 12px;
      border:1px solid var(--border-strong);
      border-radius:14px;
      font-size:14px;
      min-width:160px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    input::placeholder{color:#8c90a3}
    input:focus,select:focus{
      border-color: rgba(54,124,43,.85);
      box-shadow: 0 0 0 4px rgba(54,124,43,.20);
    }
    input[type="date"]{min-width:170px;color-scheme:dark}

    button{
      padding:10px 12px;border:1px solid var(--border-strong);
      background: rgba(255,255,255,.04);
      border-radius:14px;cursor:pointer;
      transition:.12s ease;font-weight:900;color:#e7e7ea;
      box-shadow: var(--shadow2);
    }
    button:hover{transform: translateY(-1px)}
    button.primary{
      background: rgba(54,124,43,.85);
      border-color: rgba(54,124,43,.85);
      color:#fff;
      box-shadow: 0 12px 22px rgba(54,124,43,.18);
    }
    button.secondary{
      border-color: rgba(54,124,43,.55);
      color:#d9f1d3;
      background: rgba(54,124,43,.12);
    }
    button.danger{
      color:#ffd7dc;border-color:#5a2731;background: rgba(176,0,32,.16);
    }
    button.small{padding:7px 10px;border-radius:12px;font-size:12px;box-shadow:none;font-weight:900}
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .muted{color:var(--muted);font-size:12px;margin-top:8px}
    .toast{margin-top:10px;font-size:13px;color:#9cf08a;display:none;font-weight:900}
    .toast.err{color:#ff8b97}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    thead th{
      background: rgba(255,255,255,.02);
      position:sticky;top:0;z-index:2;
      text-align:center;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px;font-size:14px;vertical-align:top;
      white-space:nowrap;text-align:center;color:#e7e7ea;
    }
    th{
      font-size:12px;letter-spacing:.06em;text-transform:uppercase;
      color:#cfd1da;position:relative;
    }
    th::after{
      content:"";
      position:absolute;left:0;bottom:0;width:100%;height:3px;
      background: linear-gradient(90deg, rgba(54,124,43,.95), rgba(255,222,0,.75));
      opacity:.95;
    }
    tbody tr:nth-child(odd){background: rgba(255,255,255,.01)}
    tbody tr:hover{background: rgba(54,124,43,.10)}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .cell-input{
      min-width:120px;padding:7px 10px;border-radius:12px;
      border:1px solid var(--border-strong);
      background: rgba(255,255,255,.03);
      color: var(--text);
      text-align:center;
    }

    .w220{min-width:220px}
    .w200{min-width:200px}
    .w160{min-width:160px}
    .w140{min-width:140px}
    .w110{min-width:110px}

    .footer{
      position:fixed;left:16px;bottom:12px;font-size:12px;
      color:#e7e7ea;background: rgba(0,0,0,.45);
      border:1px solid var(--border);
      border-left:7px solid var(--jd-green);
      padding:9px 12px;border-radius:14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }
    .footer b{color:var(--jd-green)}

    /* Adjuntos UI */
    .attList{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .attItem{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      padding:8px 10px;border-radius:12px;
    }
    .attName{max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;color:#d6d7df}
    .attLinks{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
    a{color:#d9f1d3}
    .pillX{
      display:inline-flex;align-items:center;justify-content:center;
      width:22px;height:22px;border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(176,0,32,.16);
      color:#ffd7dc;font-weight:900;
      cursor:pointer;
    }

    .row-add{
      display:flex;
      flex-wrap: nowrap;
      gap:10px;
      align-items:flex-end;
    }
    .row-add > div{flex:0 1 auto; min-width:0;}
    .row-add input, .row-add select{min-width:120px;}
    .row-add .w200{min-width:160px}
    .row-add .w140{min-width:120px}
    .row-add input[type="date"]{min-width:140px}

    .attWrap{
      margin-left:auto;
      flex: 0 0 270px;
      max-width: 270px;
    }

    .row-add input[type="file"]{
      min-width:270px;
      max-width:270px;
      padding:8px 10px;
    }
    .row-add input[type="file"]::file-selector-button{
      padding:8px 10px;
      border:1px solid var(--border-strong);
      background: rgba(255,255,255,.06);
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      color: var(--text);
      margin-right:8px;
    }

    @media (max-width: 1200px){
      .row-add{overflow-x:auto;padding-bottom:6px}
      .row-add::-webkit-scrollbar{height:8px}
      .row-add::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12);border-radius:999px}
    }
  </style>
</head>

<body>

  <!-- ✅ LOGIN -->
  <div id="loginBox" class="card" style="max-width:420px;margin:80px auto;">
    <div class="accentBar"></div>
    <h3>Ingresar</h3>

    <label>Email</label>
    <input id="loginEmail" type="email" placeholder="usuario@empresa.com"/>

    <label style="margin-top:10px">Contraseña</label>
    <input id="loginPass" type="password" placeholder="••••••••"/>

    <button id="loginBtn" class="primary" style="margin-top:14px;width:100%">
      Ingresar
    </button>

    <div id="loginError" class="toast err" style="display:none"></div>
  </div>

  <!-- ✅ APP (se muestra solo si hay usuario logueado) -->
  <div id="appContent" style="display:none">

    <div class="topbar">
      <h1 class="title"><span class="brandDot"></span> Carga de datos</h1>
      <div class="row" style="gap:8px;align-items:center">
        <div class="subpill">Estilo <b>Interagrovial</b> · verde/amarillo</div>
        <button id="logoutBtn" class="secondary" type="button">Salir</button>
      </div>
    </div>

    <!-- FILTROS + EXPORT -->
    <div class="card">
      <div class="accentBar"></div>
      <div class="cardHeader">
        <h3>Filtros</h3>
        <div class="row" style="gap:8px">
          <button id="exportBtn" class="primary" type="button">Descargar Excel</button>
          <button id="clearFiltersBtn" class="secondary" type="button">Limpiar filtros</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Buscar (cualquier campo)</label>
          <input id="q" class="w220" placeholder="Ej: 12004566 / AGRO / 88855"/>
        </div>

        <div>
          <label>División</label>
          <select id="fDivision">
            <option value="">(Todas)</option>
          </select>
        </div>

        <div>
          <label>Condiciones</label>
          <select id="fCond">
            <option value="">(Todas)</option>
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div>
          <label>WIS</label>
          <select id="fWis">
            <option value="">(Todas)</option>
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div>
          <label>Cierre de carpeta</label>
          <select id="fCierre">
            <option value="">(Todas)</option>
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div>
          <label>Fecha estimada desde</label>
          <input id="fDateFrom" type="date"/>
        </div>

        <div>
          <label>Fecha estimada hasta</label>
          <input id="fDateTo" type="date"/>
        </div>
      </div>

      <div class="muted">Los filtros se aplican automáticamente sobre la tabla. “Descargar Excel” exporta lo filtrado.</div>
    </div>

    <!-- FORMULARIO AGREGAR -->
    <div class="card">
      <div class="accentBar"></div>
      <h3>Agregar fila</h3>

      <div class="row row-add">
        <div>
          <label>Factura</label>
          <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
        </div>

        <div>
          <label>División</label>
          <input id="division" class="w200" placeholder="Ej: AGRO"/>
        </div>

        <div>
          <label>Transporte</label>
          <input id="transporte" class="w200" placeholder="Ej: Barco / Avión"/>
        </div>

        <div>
          <label>Carpeta</label>
          <input id="carpeta" class="w140" placeholder="Ej: 88855"/>
        </div>

        <div>
          <label>Fecha estimada</label>
          <input id="fecha_estimada" type="date" />
        </div>

        <div>
          <label>Orden de compra</label>
          <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
        </div>

        <div>
          <label>Condiciones</label>
          <select id="cond">
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div>
          <label>WIS</label>
          <select id="wis">
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div>
          <label>Cierre de carpeta</label>
          <select id="cierre">
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div class="attWrap">
          <label>Adjuntos</label>
          <input id="adjuntos" type="file" multiple />
          <div id="attPreview" class="attList"></div>
        </div>

        <button id="addBtn" class="primary" type="button">Agregar</button>
      </div>

      <div id="msg" class="muted"></div>
      <div id="toast" class="toast"></div>
    </div>

    <!-- TABLA -->
    <table>
      <thead>
        <tr>
          <th>Fecha carga</th>
          <th>Factura</th>
          <th>División</th>
          <th>Transporte</th>
          <th>Carpeta</th>
          <th>Fecha estimada</th>
          <th>Orden compra</th>
          <th>Condiciones</th>
          <th>WIS</th>
          <th>Cierre carpeta</th>
          <th>Adjuntos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer"><b>INTERAGROVIAL S.A</b></div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIGkNekvGn0XrqGvDAuutCBSglod03644",
      authDomain: "carpetas-17846.firebaseapp.com",
      projectId: "carpetas-17846",
      storageBucket: "carpetas-17846.firebasestorage.app",
      messagingSenderId: "513234224676",
      appId: "1:513234224676:web:a61b7ab9685594d1b5bab1",
      measurementId: "G-8Z18FTM0L6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const $ = (id) => document.getElementById(id);

    // UI login/app
    const loginBox = $("loginBox");
    const appContent = $("appContent");
    const loginBtn = $("loginBtn");
    const loginError = $("loginError");
    const logoutBtn = $("logoutBtn");

    // App UI
    const tbody = $("tbody");
    const msgEl = $("msg");
    const toastEl = $("toast");
    const addBtn = $("addBtn");

    // Helpers
    function showToast(text, isError=false){
      toastEl.textContent = text;
      toastEl.classList.toggle("err", isError);
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 4500);
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function errText(e){
      const code = e?.code ? `[${e.code}] ` : "";
      const msg = e?.message || String(e);
      return code + msg;
    }
    function safeYesNo(v){ return (v === "NO") ? "NO" : "SI"; }
    function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}_${Math.random().toString(16).slice(2)}`); }
    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

    // ✅ LOGIN CLICK
    loginBtn.addEventListener("click", async () => {
      loginError.style.display = "none";
      loginBtn.disabled = true;

      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;

      if (!email || !pass) {
        loginError.textContent = "Ingresá email y contraseña";
        loginError.style.display = "block";
        loginBtn.disabled = false;
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        console.error("LOGIN ERROR:", e);
        loginError.textContent = errText(e);
        loginError.style.display = "block";
      } finally {
        loginBtn.disabled = false;
      }
    });

    // ✅ LOGOUT
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ✅ MOSTRAR / OCULTAR SEGÚN SESIÓN
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.style.display = "none";
        appContent.style.display = "block";
        addBtn.disabled = false;
      } else {
        loginBox.style.display = "block";
        appContent.style.display = "none";
        addBtn.disabled = true;
      }
    });

    // ----------- TU APP (mismo código de antes) -----------
    let editingRowId = null;
    let cache = [];
    let view = [];
    let selectedFiles = [];

    function clearAddForm() {
      $("factura").value = "";
      $("division").value = "";
      $("transporte").value = "";
      $("carpeta").value = "";
      $("fecha_estimada").value = "";
      $("oc").value = "";
      $("cond").value = "SI";
      $("wis").value = "SI";
      $("cierre").value = "SI";

      selectedFiles = [];
      $("adjuntos").value = "";
      renderAttPreview();
    }

    function renderAttPreview(){
      const wrap = $("attPreview");
      if (!selectedFiles.length){
        wrap.innerHTML = `<div class="muted">Sin adjuntos.</div>`;
        return;
      }
      wrap.innerHTML = selectedFiles.map((f, idx) => `
        <div class="attItem">
          <div class="attName">${escapeHtml(f.name)} (${Math.round(f.size/1024)} KB)</div>
          <button class="small danger" type="button" data-att-remove="${idx}">Quitar</button>
        </div>
      `).join("");
    }

    $("adjuntos").addEventListener("change", (e) => {
      const incoming = Array.from(e.target.files || []);
      if (incoming.length) selectedFiles = selectedFiles.concat(incoming);
      $("adjuntos").value = "";
      renderAttPreview();
    });

    $("attPreview").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-att-remove]");
      if (!btn) return;
      const idx = Number(btn.dataset.attRemove);
      if (Number.isNaN(idx)) return;
      selectedFiles.splice(idx, 1);
      renderAttPreview();
    });

    function matchesText(row, q){
      if (!q) return true;
      const atts = (row.attachments || []).map(a => a?.name || "").join(" ");
      const hay = [
        row.factura, row.division, row.transporte, row.carpeta,
        row.fecha_estimada, row.oc, row.cond, row.wis, row.cierre, atts
      ].map(norm).join(" | ");
      return hay.includes(q);
    }

    function inDateRange(row, from, to){
      const d = row.fecha_estimada || "";
      if (!from && !to) return true;
      if (!d) return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function applyFilters(){
      const q = norm($("q").value);
      const fDivision = $("fDivision").value;
      const fCond = $("fCond").value;
      const fWis = $("fWis").value;
      const fCierre = $("fCierre").value;
      const from = $("fDateFrom").value || "";
      const to = $("fDateTo").value || "";

      view = cache.filter(x => {
        const r = x.data;
        if (fDivision && (r.division || "") !== fDivision) return false;
        if (fCond && (r.cond || "") !== fCond) return false;
        if (fWis && (r.wis || "") !== fWis) return false;
        if (fCierre && (r.cierre || "") !== fCierre) return false;
        if (!matchesText(r, q)) return false;
        if (!inDateRange(r, from, to)) return false;
        return true;
      });

      draw();
    }

    function rebuildDivisionOptions(){
      const sel = $("fDivision");
      const current = sel.value;
      const values = Array.from(new Set(cache.map(x => (x.data.division || "").trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">(Todas)</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      if (values.includes(current)) sel.value = current;
    }

    ["q","fDivision","fCond","fWis","fCierre","fDateFrom","fDateTo"].forEach(id=>{
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("clearFiltersBtn").addEventListener("click", ()=>{
      $("q").value = "";
      $("fDivision").value = "";
      $("fCond").value = "";
      $("fWis").value = "";
      $("fCierre").value = "";
      $("fDateFrom").value = "";
      $("fDateTo").value = "";
      applyFilters();
    });

    async function uploadOne(rowId, file){
      const path = `rows/${rowId}/${uid()}_${file.name}`;
      const ref = sRef(storage, path);
      const task = uploadBytesResumable(ref, file);

      await new Promise((resolve, reject) => {
        task.on("state_changed",
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            msgEl.textContent = `Subiendo adjuntos... ${pct}%`;
          },
          (err) => reject(err),
          () => resolve()
        );
      });

      const url = await getDownloadURL(ref);
      return { name: file.name, path, url, size: file.size };
    }

    async function uploadAttachments(rowId, files){
      const out = [];
      for (const f of files) out.push(await uploadOne(rowId, f));
      return out;
    }

    function renderAttachmentsCell(r){
      const atts = r.attachments || [];
      if (!atts.length) return `<span class="muted">—</span>`;
      return `
        <div class="attLinks">
          ${atts.map((a, idx) => `
            <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.name || "Adjunto")}</a>
            <span class="pillX" title="Borrar adjunto" data-action="delatt" data-att-idx="${idx}">×</span>
          `).join("")}
        </div>
      `;
    }

    addBtn.addEventListener("click", async () => {
      const data = {
        factura: $("factura").value.trim(),
        division: $("division").value.trim(),
        transporte: $("transporte").value.trim(),
        carpeta: $("carpeta").value.trim(),
        fecha_estimada: $("fecha_estimada").value || "",
        oc: $("oc").value.trim(),
        cond: safeYesNo($("cond").value),
        wis: safeYesNo($("wis").value),
        cierre: safeYesNo($("cierre").value),
        attachments: [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const empty =
        !data.factura && !data.division && !data.transporte && !data.carpeta &&
        !data.fecha_estimada && !data.oc && !selectedFiles.length;

      if (empty) { alert("Ingresá al menos un dato o adjuntá un archivo para agregar."); return; }

      addBtn.disabled = true;
      msgEl.textContent = "Guardando...";

      let rowId = null;
      try {
        const docRef = await addDoc(collection(db, "rows"), data);
        rowId = docRef.id;

        if (selectedFiles.length){
          const uploaded = await uploadAttachments(rowId, selectedFiles);
          msgEl.textContent = "Actualizando fila...";
          await updateDoc(doc(db, "rows", rowId), { attachments: uploaded, updatedAt: serverTimestamp() });
        }

        msgEl.textContent = "";
        clearAddForm();
        showToast("Agregado con éxito");
      } catch (e) {
        console.error("ERROR:", e);
        showToast(`Error: ${errText(e)}`, true);
        alert(errText(e));
      } finally {
        addBtn.disabled = false;
        msgEl.textContent = "";
      }
    });

    function renderRow(id, r) {
      const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      const dtTxt = dt ? dt.toLocaleString() : "";
      const isEditing = (editingRowId === id);

      if (!isEditing) {
        return `
          <tr data-id="${id}">
            <td>${escapeHtml(dtTxt)}</td>
            <td>${escapeHtml(r.factura)}</td>
            <td>${escapeHtml(r.division)}</td>
            <td>${escapeHtml(r.transporte)}</td>
            <td>${escapeHtml(r.carpeta)}</td>
            <td>${escapeHtml(r.fecha_estimada)}</td>
            <td>${escapeHtml(r.oc)}</td>
            <td>${escapeHtml(r.cond)}</td>
            <td>${escapeHtml(r.wis)}</td>
            <td>${escapeHtml(r.cierre)}</td>
            <td>${renderAttachmentsCell(r)}</td>
            <td>
              <div class="actions">
                <button class="small secondary" data-action="edit">Editar</button>
                <button class="small danger" data-action="delete">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }

      const factura = escapeHtml(r.factura || "");
      const division = escapeHtml(r.division || "");
      const transporte = escapeHtml(r.transporte || "");
      const carpeta = escapeHtml(r.carpeta || "");
      const fecha_estimada = escapeHtml(r.fecha_estimada || "");
      const oc = escapeHtml(r.oc || "");
      const cond = safeYesNo(r.cond || "SI");
      const wis = safeYesNo(r.wis || "SI");
      const cierre = safeYesNo(r.cierre || "SI");

      return `
        <tr data-id="${id}">
          <td>${escapeHtml(dtTxt)}</td>
          <td><input class="cell-input w140" data-field="factura" value="${factura}"></td>
          <td><input class="cell-input w200" data-field="division" value="${division}"></td>
          <td><input class="cell-input w200" data-field="transporte" value="${transporte}"></td>
          <td><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></td>
          <td><input class="cell-input w160" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></td>
          <td><input class="cell-input w140" data-field="oc" value="${oc}"></td>

          <td>
            <select class="cell-input w110" data-field="cond">
              <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <select class="cell-input w110" data-field="wis">
              <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <select class="cell-input w110" data-field="cierre">
              <option value="SI" ${cierre==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cierre==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            ${renderAttachmentsCell(r)}
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
              <input type="file" multiple data-edit-files style="max-width:260px"/>
              <button class="small secondary" type="button" data-action="upload">Subir adjuntos</button>
            </div>
          </td>

          <td>
            <div class="actions">
              <button class="small primary" data-action="save">Guardar</button>
              <button class="small" data-action="cancel">Cancelar</button>
              <button class="small danger" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    function draw() {
      const dataToDraw = (view.length ? view : cache);
      tbody.innerHTML = dataToDraw.map(x => renderRow(x.id, x.data)).join("");
    }

    const qSnap = query(collection(db, "rows"), orderBy("createdAt", "desc"));
    onSnapshot(qSnap, (snap) => {
      cache = [];
      snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
      rebuildDivisionOptions();
      applyFilters();
    }, (err) => {
      console.error(err);
      showToast("No se pudo leer Firestore", true);
    });

    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit") { editingRowId = id; draw(); return; }
      if (action === "cancel") { editingRowId = null; draw(); return; }

      if (action === "upload") {
        const row = cache.find(x => x.id === id);
        const currentAtts = row?.data?.attachments || [];

        const fileInput = tr.querySelector('input[type="file"][data-edit-files]');
        const files = Array.from(fileInput?.files || []);

        if (!files.length) { alert("Elegí uno o más archivos para subir."); return; }

        try {
          btn.disabled = true;
          msgEl.textContent = "Subiendo adjuntos...";

          const uploaded = await uploadAttachments(id, files);
          const next = currentAtts.concat(uploaded);

          await updateDoc(doc(db, "rows", id), { attachments: next, updatedAt: serverTimestamp() });

          msgEl.textContent = "";
          fileInput.value = "";
          showToast("Adjuntos subidos");
        } catch (err) {
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
          msgEl.textContent = "";
        }
        return;
      }

      if (action === "save") {
        const fields = tr.querySelectorAll("[data-field]");
        const updated = {};
        fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());

        updated.cond = safeYesNo(updated.cond);
        updated.wis  = safeYesNo(updated.wis);
        updated.cierre  = safeYesNo(updated.cierre);

        try {
          btn.disabled = true;
          await updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() });
          editingRowId = null;
          showToast("Modificado con éxito");
        } catch (err) {
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delatt") {
        const idx = Number(btn.dataset.attIdx);
        const row = cache.find(x => x.id === id);
        const atts = row?.data?.attachments || [];
        const att = atts[idx];
        if (!att?.path) return;

        if (!confirm(`¿Borrar adjunto "${att.name}"?`)) return;

        try {
          btn.disabled = true;
          await deleteObject(sRef(storage, att.path));

          const next = atts.filter((_, i) => i !== idx);
          await updateDoc(doc(db, "rows", id), { attachments: next, updatedAt: serverTimestamp() });

          showToast("Adjunto borrado");
        } catch (err) {
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delete") {
        const row = cache.find(x => x.id === id);
        const atts = row?.data?.attachments || [];

        if (!confirm("¿Seguro que querés eliminar esta fila? (Borra adjuntos también)")) return;

        try {
          btn.disabled = true;

          for (const a of atts) {
            if (a?.path) await deleteObject(sRef(storage, a.path));
          }
          await deleteDoc(doc(db, "rows", id));

          if (editingRowId === id) editingRowId = null;
          showToast("Eliminado con éxito");
        } catch (err) {
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
      }
    });

    renderAttPreview();
  </script>
</body>
</html>
