<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos - Interagrovial</title>

  <style>
    :root{
      /* John Deere-ish */
      --jd-green:#367c2b;
      --jd-yellow:#ffde00;
      --border:#e7e7e7;
      --text:#111;
      --muted:#666;
      --bg:#ffffff;
      --card:#ffffff;
      --shadow:0 1px 2px rgba(0,0,0,.06);
      --radius:14px;
    }

    body{
      font-family: Arial, sans-serif;
      margin: 24px;
      background: var(--bg);
      color: var(--text);
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      display:flex;align-items:center;gap:10px;
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    .brandDot{
      width:14px;height:14px;border-radius:999px;
      background: var(--jd-green);
      box-shadow: inset 0 0 0 3px var(--jd-yellow);
    }
    .subpill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;
      background:#fff;
      font-size:12px;color:#333;
    }
    .subpill b{color:var(--jd-green)}

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .card h3{margin:0 0 10px;font-size:14px}
    .cardHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .accentBar{
      height:4px;border-radius:999px;
      background: linear-gradient(90deg, var(--jd-green), var(--jd-yellow));
      margin:-16px -16px 14px -16px;
    }

    /* Form layout */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    label{
      font-size:12px;
      color:#444;
      display:block;
      margin-bottom:6px
    }
    input,select{
      padding:10px;
      border:1px solid #cfcfcf;
      border-radius:12px;
      font-size:14px;
      min-width:160px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus{
      border-color: var(--jd-green);
      box-shadow: 0 0 0 3px rgba(54,124,43,.12);
    }
    input[type="date"]{min-width:170px}

    /* Buttons */
    button{
      padding:10px 12px;
      border:1px solid #cfcfcf;
      background:#fff;
      border-radius:12px;
      cursor:pointer;
      transition:.12s ease;
    }
    button.primary{
      background: var(--jd-green);
      color:#fff;
      border-color: var(--jd-green);
    }
    button.primary:hover{filter:brightness(0.95)}
    button.secondary{
      border-color: var(--jd-green);
      color: var(--jd-green);
      background:#fff;
    }
    button.danger{
      color:#b00020;
      border-color:#f1c1c8;
      background:#fff;
    }
    button.small{
      padding:6px 10px;
      border-radius:12px;
      font-size:12px;
    }
    button[disabled]{opacity:.6;cursor:not-allowed}

    .muted{color:var(--muted);font-size:12px;margin-top:8px}
    .toast{
      margin-top:10px;
      font-size:13px;
      color: var(--jd-green);
      display:none;
      font-weight:700;
    }
    .toast.err{color:#b00020;font-weight:700}

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    th,td{
      border-bottom:1px solid #efefef;
      padding:10px;
      text-align:left;
      font-size:14px;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      background: linear-gradient(0deg, #fff, #fff);
      position:relative;
    }
    th::after{
      content:"";
      position:absolute;left:0;bottom:0;width:100%;height:3px;
      background: linear-gradient(90deg, var(--jd-green), var(--jd-yellow));
      opacity:.9;
    }

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .cell-input{
      min-width:120px;
      padding:6px 8px;
      border-radius:10px;
    }
    .w200{min-width:200px}
    .w140{min-width:140px}
    .w110{min-width:110px}

    /* Footer fixed */
    .footer{
      position:fixed;
      left:16px;
      bottom:12px;
      font-size:12px;
      color:#222;
      background: rgba(255,255,255,.9);
      border:1px solid var(--border);
      border-left:6px solid var(--jd-green);
      padding:8px 10px;
      border-radius:12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(3px);
    }
    .footer b{color:var(--jd-green)}
  </style>
</head>

<body>

  <div class="topbar">
    <h1 class="title"><span class="brandDot"></span> Carga de datos</h1>
    <div class="subpill">Estilo <b>Interagrovial</b> · verde/amarillo</div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <div class="accentBar"></div>
    <div class="cardHeader">
      <h3>Filtros</h3>
      <button id="clearFiltersBtn" class="secondary" type="button">Limpiar filtros</button>
    </div>

    <div class="row">
      <div>
        <label>Buscar (cualquier campo)</label>
        <input id="q" class="w200" placeholder="Ej: 12004566 / AGRO / 88855"/>
      </div>

      <div>
        <label>División</label>
        <select id="fDivision">
          <option value="">(Todas)</option>
        </select>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="fCond">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="fWis">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Fecha estimada desde</label>
        <input id="fDateFrom" type="date"/>
      </div>

      <div>
        <label>Fecha estimada hasta</label>
        <input id="fDateTo" type="date"/>
      </div>
    </div>

    <div class="muted">Los filtros se aplican sobre la tabla automáticamente.</div>
  </div>

  <!-- FORMULARIO AGREGAR -->
  <div class="card">
    <div class="accentBar"></div>
    <h3>Agregar fila</h3>

    <div class="row">
      <div>
        <label>Factura</label>
        <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
      </div>

      <div>
        <label>División</label>
        <input id="division" class="w200" placeholder="Ej: AGRO"/>
      </div>

      <div>
        <label>Transporte</label>
        <input id="transporte" class="w200" placeholder="Ej: Barco / Avión"/>
      </div>

      <div>
        <label>Carpeta</label>
        <input id="carpeta" class="w140" inputmode="numeric" placeholder="Ej: 88855"/>
      </div>

      <div>
        <label>Fecha estimada</label>
        <input id="fecha_estimada" type="date" />
      </div>

      <div>
        <label>Orden de compra</label>
        <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="cond">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="wis">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <button id="addBtn" class="primary" type="button">Agregar</button>
    </div>

    <div id="msg" class="muted"></div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>Fecha carga</th>
        <th>Factura</th>
        <th>División</th>
        <th>Transporte</th>
        <th>Carpeta</th>
        <th>Fecha estimada</th>
        <th>Orden de compra</th>
        <th>Condiciones</th>
        <th>WIS</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer"><b>INTERAGROVIAL S.A</b></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    initializeFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
    serverTimestamp, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ✅ DEJÁ TU CONFIG REAL (la que ya te funciona)
const firebaseConfig = {
  apiKey: "AIzaSyDIgNEkvCng0XrqGvDAuutCBSglodO3644",
  authDomain: "carpetas-17846.firebaseapp.com",
  projectId: "carpetas-17846",
  storageBucket: "carpetas-17846.firebasestorage.app",
  messagingSenderId: "513234224676",
  appId: "1:513234224676:web:a61b7ab9685594d1b5bab1",
  measurementId: "G-8Z18FTM0L6"
};

  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, {
    experimentalForceLongPolling: true,
    useFetchStreams: false
  });

  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const msgEl = $("msg");
  const toastEl = $("toast");
  const addBtn = $("addBtn");

  let editingRowId = null;
  let cache = [];        // snapshot sin filtrar
  let view = [];         // cache filtrada

  function showToast(text, isError=false){
    toastEl.textContent = text;
    toastEl.classList.toggle("err", isError);
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.style.display = "none", 2500);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function clearAddForm() {
    $("factura").value = "";
    $("division").value = "";
    $("transporte").value = "";
    $("carpeta").value = "";
    $("fecha_estimada").value = "";
    $("oc").value = "";
    $("cond").value = "SI";
    $("wis").value = "SI";
  }

  function withTimeout(promise, ms, timeoutMsg="Tiempo de espera agotado") {
    let t;
    const timeout = new Promise((_, rej) => { t = setTimeout(() => rej(new Error(timeoutMsg)), ms); });
    return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
  }

  // ---- Filtros ----
  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

  function matchesText(row, q){
    if (!q) return true;
    const hay = [
      row.factura, row.division, row.transporte, row.carpeta,
      row.fecha_estimada, row.oc, row.cond, row.wis
    ].map(norm).join(" | ");
    return hay.includes(q);
  }

  function inDateRange(row, from, to){
    const d = row.fecha_estimada || "";
    if (!from && !to) return true;
    if (!d) return false;
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  }

  function applyFilters(){
    const q = norm($("q").value);
    const fDivision = $("fDivision").value;
    const fCond = $("fCond").value;
    const fWis = $("fWis").value;
    const from = $("fDateFrom").value || "";
    const to = $("fDateTo").value || "";

    view = cache.filter(x => {
      const r = x.data;
      if (fDivision && (r.division || "") !== fDivision) return false;
      if (fCond && (r.cond || "") !== fCond) return false;
      if (fWis && (r.wis || "") !== fWis) return false;
      if (!matchesText(r, q)) return false;
      if (!inDateRange(r, from, to)) return false;
      return true;
    });

    draw();
  }

  function rebuildDivisionOptions(){
    const sel = $("fDivision");
    const current = sel.value;
    const values = Array.from(new Set(cache.map(x => (x.data.division || "").trim()).filter(Boolean))).sort();
    sel.innerHTML = `<option value="">(Todas)</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    // intentar preservar selección si existe
    if (values.includes(current)) sel.value = current;
  }

  ["q","fDivision","fCond","fWis","fDateFrom","fDateTo"].forEach(id=>{
    $(id).addEventListener("input", applyFilters);
    $(id).addEventListener("change", applyFilters);
  });

  $("clearFiltersBtn").addEventListener("click", ()=>{
    $("q").value = "";
    $("fDivision").value = "";
    $("fCond").value = "";
    $("fWis").value = "";
    $("fDateFrom").value = "";
    $("fDateTo").value = "";
    applyFilters();
  });

  // ---- CRUD ----
  addBtn.addEventListener("click", async () => {
    const data = {
      factura: $("factura").value.trim(),
      division: $("division").value.trim(),
      transporte: $("transporte").value.trim(),
      carpeta: $("carpeta").value.trim(),
      fecha_estimada: $("fecha_estimada").value || "",
      oc: $("oc").value.trim(),
      cond: $("cond").value,
      wis: $("wis").value,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const empty =
      !data.factura && !data.division && !data.transporte && !data.carpeta &&
      !data.fecha_estimada && !data.oc;

    if (empty) { alert("Ingresá al menos un dato para agregar."); return; }

    try {
      msgEl.textContent = "Guardando...";
      addBtn.disabled = true;
      await withTimeout(addDoc(collection(db, "rows"), data), 15000, "Red lenta/bloqueada.");
      msgEl.textContent = "";
      clearAddForm();
      showToast("Agregado con éxito");
    } catch (e) {
      console.error(e);
      msgEl.textContent = "";
      showToast("No se pudo guardar", true);
      alert("No se pudo guardar. Revisá reglas/permisos o la red.");
    } finally {
      addBtn.disabled = false;
    }
  });

  function renderRow(id, r) {
    const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
    const dtTxt = dt ? dt.toLocaleString() : "";
    const isEditing = (editingRowId === id);

    if (!isEditing) {
      return `
        <tr data-id="${id}">
          <td>${escapeHtml(dtTxt)}</td>
          <td>${escapeHtml(r.factura)}</td>
          <td>${escapeHtml(r.division)}</td>
          <td>${escapeHtml(r.transporte)}</td>
          <td>${escapeHtml(r.carpeta)}</td>
          <td>${escapeHtml(r.fecha_estimada)}</td>
          <td>${escapeHtml(r.oc)}</td>
          <td>${escapeHtml(r.cond)}</td>
          <td>${escapeHtml(r.wis)}</td>
          <td>
            <div class="actions">
              <button class="small secondary" data-action="edit">Editar</button>
              <button class="small danger" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    const factura = escapeHtml(r.factura || "");
    const division = escapeHtml(r.division || "");
    const transporte = escapeHtml(r.transporte || "");
    const carpeta = escapeHtml(r.carpeta || "");
    const fecha_estimada = escapeHtml(r.fecha_estimada || "");
    const oc = escapeHtml(r.oc || "");
    const cond = r.cond || "SI";
    const wis = r.wis || "SI";

    return `
      <tr data-id="${id}">
        <td>${escapeHtml(dtTxt)}</td>

        <td><input class="cell-input w140" data-field="factura" value="${factura}"></td>
        <td><input class="cell-input w200" data-field="division" value="${division}"></td>
        <td><input class="cell-input w200" data-field="transporte" value="${transporte}"></td>
        <td><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></td>
        <td><input class="cell-input w140" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></td>
        <td><input class="cell-input w140" data-field="oc" value="${oc}"></td>

        <td>
          <select class="cell-input w110" data-field="cond">
            <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
            <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
          </select>
        </td>

        <td>
          <select class="cell-input w110" data-field="wis">
            <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
            <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
          </select>
        </td>

        <td>
          <div class="actions">
            <button class="small primary" data-action="save">Guardar</button>
            <button class="small" data-action="cancel">Cancelar</button>
            <button class="small danger" data-action="delete">Eliminar</button>
          </div>
        </td>
      </tr>
    `;
  }

  function draw() {
    tbody.innerHTML = (view.length ? view : cache).map(x => renderRow(x.id, x.data)).join("");
  }

  // Listener tiempo real
  const q = query(collection(db, "rows"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    cache = [];
    snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
    rebuildDivisionOptions();
    applyFilters();
  }, (err) => {
    console.error(err);
    showToast("No se pudo leer Firestore", true);
  });

  // Acciones tabla
  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;

    const id = tr.dataset.id;
    const action = btn.dataset.action;

    if (action === "edit") { editingRowId = id; draw(); return; }
    if (action === "cancel") { editingRowId = null; draw(); return; }

    if (action === "save") {
      const fields = tr.querySelectorAll("[data-field]");
      const updated = {};
      fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());
      updated.cond = updated.cond === "NO" ? "NO" : "SI";
      updated.wis  = updated.wis  === "NO" ? "NO" : "SI";

      const empty =
        !updated.factura && !updated.division && !updated.transporte && !updated.carpeta &&
        !updated.fecha_estimada && !updated.oc;

      if (empty) { alert("La fila no puede quedar vacía."); return; }

      try {
        btn.disabled = true;
        await withTimeout(updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() }), 15000);
        editingRowId = null;
        showToast("Modificado con éxito");
        // se refresca solo por onSnapshot, pero re-dibuja ya
        applyFilters();
      } catch (err) {
        console.error(err);
        showToast("No se pudo modificar", true);
        alert("No se pudo modificar. Revisá reglas/permisos o red.");
      } finally {
        btn.disabled = false;
      }
      return;
    }

    if (action === "delete") {
      if (!confirm("¿Seguro que querés eliminar esta fila?")) return;
      try {
        btn.disabled = true;
        await withTimeout(deleteDoc(doc(db, "rows", id)), 15000);
        if (editingRowId === id) editingRowId = null;
        showToast("Eliminado con éxito");
      } catch (err) {
        console.error(err);
        showToast("No se pudo eliminar", true);
        alert("No se pudo eliminar. Revisá reglas/permisos o red.");
      } finally {
        btn.disabled = false;
      }
    }
  });
</script>

</body>
</html>
