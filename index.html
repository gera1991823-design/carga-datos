<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos</title>

  <style>
    body{font-family:Arial,sans-serif;margin:24px;background:#fafafa}
    h1{margin:0 0 16px;font-size:20px}
    .card{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:#444;display:block;margin-bottom:6px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px;font-size:14px;min-width:160px}
    input[type="date"]{min-width:170px}
    button{padding:10px 12px;border:1px solid #ccc;background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.danger{color:#b00020;border-color:#f1c1c8}
    button.small{padding:6px 10px;border-radius:10px;font-size:12px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:12px;margin-top:8px}
    .toast{margin-top:10px;font-size:13px;color:#0a6;display:none}
    .toast.err{color:#b00020}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#f6f6f6;white-space:nowrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .cell-input{min-width:120px;padding:6px 8px;border-radius:8px}
    .w200{min-width:200px}
    .w140{min-width:140px}
    .w110{min-width:110px}
  </style>
</head>

<body>
<h1>Carga de datos</h1>

<div class="card">
  <h3 style="margin-top:0">Agregar fila</h3>

  <div class="row">
    <div>
      <label>Factura</label>
      <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
    </div>

    <div>
      <label>División</label>
      <input id="division" class="w200" placeholder="Ej: AGRO"/>
    </div>

    <div>
      <label>Transporte</label>
      <input id="transporte" class="w200" placeholder="Ej: Barco / Avión"/>
    </div>

    <div>
      <label>Carpeta</label>
      <input id="carpeta" class="w140" inputmode="numeric" placeholder="Ej: 88855"/>
    </div>

    <div>
      <label>Fecha estimada</label>
      <input id="fecha_estimada" type="date" />
    </div>

    <div>
      <label>Orden de compra</label>
      <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
    </div>

    <div>
      <label>Condiciones</label>
      <select id="cond">
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>
    </div>

    <div>
      <label>WIS</label>
      <select id="wis">
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>
    </div>

    <button id="addBtn" class="primary" type="button">Agregar</button>
  </div>

  <div id="msg" class="muted"></div>
  <div id="toast" class="toast"></div>
</div>

<table>
  <thead>
    <tr>
      <th>Fecha carga</th>
      <th>Factura</th>
      <th>División</th>
      <th>Transporte</th>
      <th>Carpeta</th>
      <th>Fecha estimada</th>
      <th>Orden de compra</th>
      <th>Condiciones</th>
      <th>WIS</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    initializeFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
    serverTimestamp, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ✅ PEGÁ ACÁ TU firebaseConfig REAL
  const firebaseConfig = {
    apiKey: "REEMPLAZAR",
    authDomain: "REEMPLAZAR",
    projectId: "REEMPLAZAR",
    storageBucket: "REEMPLAZAR",
    messagingSenderId: "REEMPLAZAR",
    appId: "REEMPLAZAR"
  };

  const app = initializeApp(firebaseConfig);

  // Mejor para redes corporativas
  const db = initializeFirestore(app, {
    experimentalForceLongPolling: true,
    useFetchStreams: false
  });

  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const msgEl = $("msg");
  const toastEl = $("toast");
  const addBtn = $("addBtn");

  let editingRowId = null;
  let cache = [];

  function showToast(text, isError=false){
    toastEl.textContent = text;
    toastEl.classList.toggle("err", isError);
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.style.display = "none", 2500);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function clearAddForm() {
    $("factura").value = "";
    $("division").value = "";
    $("transporte").value = "";
    $("carpeta").value = "";
    $("fecha_estimada").value = "";
    $("oc").value = "";
    $("cond").value = "SI";
    $("wis").value = "SI";
  }

  function withTimeout(promise, ms, timeoutMsg="Tiempo de espera agotado") {
    let t;
    const timeout = new Promise((_, rej) => { t = setTimeout(() => rej(new Error(timeoutMsg)), ms); });
    return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
  }

  addBtn.addEventListener("click", async () => {
    const data = {
      factura: $("factura").value.trim(),
      division: $("division").value.trim(),
      transporte: $("transporte").value.trim(),
      carpeta: $("carpeta").value.trim(),
      fecha_estimada: $("fecha_estimada").value || "",
      oc: $("oc").value.trim(),
      cond: $("cond").value,
      wis: $("wis").value,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const empty =
      !data.factura && !data.division && !data.transporte && !data.carpeta &&
      !data.fecha_estimada && !data.oc;

    if (empty) { alert("Ingresá al menos un dato para agregar."); return; }

    try {
      msgEl.textContent = "Guardando...";
      addBtn.disabled = true;
      await withTimeout(addDoc(collection(db, "rows"), data), 15000, "Red lenta/bloqueada.");
      msgEl.textContent = "";
      clearAddForm();
      showToast("Agregado con éxito");
    } catch (e) {
      console.error(e);
      msgEl.textContent = "";
      showToast("No se pudo guardar (revisar config/rules)", true);
      alert("No se pudo guardar. Revisá firebaseConfig y Rules de Firestore.");
    } finally {
      addBtn.disabled = false;
    }
  });

  function renderRow(id, r) {
    const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
    const dtTxt = dt ? dt.toLocaleString() : "";
    const isEditing = (editingRowId === id);

    if (!isEditing) {
      return `
        <tr data-id="${id}">
          <td>${escapeHtml(dtTxt)}</td>
          <td>${escapeHtml(r.factura)}</td>
          <td>${escapeHtml(r.division)}</td>
          <td>${escapeHtml(r.transporte)}</td>
          <td>${escapeHtml(r.carpeta)}</td>
          <td>${escapeHtml(r.fecha_estimada)}</td>
          <td>${escapeHtml(r.oc)}</td>
          <td>${escapeHtml(r.cond)}</td>
          <td>${escapeHtml(r.wis)}</td>
          <td>
            <div class="actions">
              <button class="small" data-action="edit">Editar</button>
              <button class="small danger" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    const factura = escapeHtml(r.factura || "");
    const division = escapeHtml(r.division || "");
    const transporte = escapeHtml(r.transporte || "");
    const carpeta = escapeHtml(r.carpeta || "");
    const fecha_estimada = escapeHtml(r.fecha_estimada || "");
    const oc = escapeHtml(r.oc || "");
    const cond = r.cond || "SI";
    const wis = r.wis || "SI";

    return `
      <tr data-id="${id}">
        <td>${escapeHtml(dtTxt)}</td>
        <td><input class="cell-input w140" data-field="factura" value="${factura}"></td>
        <td><input class="cell-input w200" data-field="division" value="${division}"></td>
        <td><input class="cell-input w200" data-field="transporte" value="${transporte}"></td>
        <td><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></td>
        <td><input class="cell-input w140" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></td>
        <td><input class="cell-input w140" data-field="oc" value="${oc}"></td>
        <td>
          <select class="cell-input w110" data-field="cond">
            <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
            <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
          </select>
        </td>
        <td>
          <select class="cell-input w110" data-field="wis">
            <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
            <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
          </select>
        </td>
        <td>
          <div class="actions">
            <button class="small primary" data-action="save">Guardar</button>
            <button class="small" data-action="cancel">Cancelar</button>
            <button class="small danger" data-action="delete">Eliminar</button>
          </div>
        </td>
      </tr>
    `;
  }

  function draw() {
    tbody.innerHTML = cache.map(x => renderRow(x.id, x.data)).join("");
  }

  const q = query(collection(db, "rows"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    cache = [];
    snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
    draw();
  }, (err) => {
    console.error(err);
    showToast("No se pudo leer Firestore (config/rules)", true);
  });

  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;

    const id = tr.dataset.id;
    const action = btn.dataset.action;

    if (action === "edit") { editingRowId = id; draw(); return; }
    if (action === "cancel") { editingRowId = null; draw(); return; }

    if (action === "save") {
      const fields = tr.querySelectorAll("[data-field]");
      const updated = {};
      fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());
      updated.cond = updated.cond === "NO" ? "NO" : "SI";
      updated.wis  = updated.wis  === "NO" ? "NO" : "SI";

      const empty =
        !updated.factura && !updated.division && !updated.transporte && !updated.carpeta &&
        !updated.fecha_estimada && !updated.oc;

      if (empty) { alert("La fila no puede quedar vacía."); return; }

      try {
        btn.disabled = true;
        await withTimeout(updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() }), 15000);
        editingRowId = null;
        draw();
        showToast("Modificado con éxito");
      } catch (err) {
        console.error(err);
        showToast("No se pudo modificar (config/rules)", true);
        alert("No se pudo modificar. Revisá Rules de Firestore.");
      } finally {
        btn.disabled = false;
      }
      return;
    }

    if (action === "delete") {
      if (!confirm("¿Seguro que querés eliminar esta fila?")) return;
      try {
        btn.disabled = true;
        await withTimeout(deleteDoc(doc(db, "rows", id)), 15000);
        if (editingRowId === id) editingRowId = null;
        showToast("Eliminado con éxito");
      } catch (err) {
        console.error(err);
        showToast("No se pudo eliminar (config/rules)", true);
        alert("No se pudo eliminar. Revisá Rules de Firestore.");
      } finally {
        btn.disabled = false;
      }
    }
  });
</script>
</body>
</html>
