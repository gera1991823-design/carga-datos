<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos - Interagrovial</title>

  <style>
    :root{
      --jd-green:#367c2b;
      --jd-yellow:#ffde00;

      --bg:#0b0b0d;
      --text:#e7e7ea;
      --muted:#a5a7b3;

      --border:#2a2d35;
      --border-strong:#3a3f4a;

      --shadow:0 18px 45px rgba(0,0,0,.55);
      --shadow2:0 8px 22px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 22px;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(54,124,43,.16), transparent 55%),
                  radial-gradient(1200px 600px at 85% 0%, rgba(255,222,0,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:14px;}
    .title{display:flex;align-items:center;gap:12px;margin:0;font-size:22px;font-weight:900;letter-spacing:.2px;}
    .brandDot{width:14px;height:14px;border-radius:999px;background:var(--jd-green);box-shadow: inset 0 0 0 3px var(--jd-yellow);}
    .subpill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.04);font-size:12px;color:#cfd1da;box-shadow:var(--shadow2);}
    .subpill b{color:var(--jd-green)}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:14px;overflow:hidden;}
    .accentBar{height:5px;border-radius:999px;background:linear-gradient(90deg, rgba(54,124,43,.95), rgba(255,222,0,.75));margin:-16px -16px 14px -16px;}
    .cardHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .card h3{margin:0 0 10px;font-size:13px;text-transform:uppercase;letter-spacing:.10em;color:#d6d7df;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:#cfd1da;display:block;margin-bottom:6px;font-weight:800}

    input,select{
      padding:10px 12px;border:1px solid var(--border-strong);border-radius:14px;font-size:14px;min-width:160px;
      background:rgba(255,255,255,.03);color:var(--text);outline:none;box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    input::placeholder{color:#8c90a3}
    input:focus,select:focus{border-color:rgba(54,124,43,.85);box-shadow:0 0 0 4px rgba(54,124,43,.20);}
    input[type="date"]{min-width:170px;color-scheme:dark}
    input[type="file"]{min-width:260px;padding:9px 12px}

    button{
      padding:10px 12px;border:1px solid var(--border-strong);background:rgba(255,255,255,.04);
      border-radius:14px;cursor:pointer;transition:.12s ease;font-weight:900;color:#e7e7ea;box-shadow:var(--shadow2);
    }
    button:hover{transform: translateY(-1px)}
    button.primary{background:rgba(54,124,43,.85);border-color:rgba(54,124,43,.85);color:#fff;box-shadow:0 12px 22px rgba(54,124,43,.18);}
    button.secondary{border-color:rgba(54,124,43,.55);color:#d9f1d3;background:rgba(54,124,43,.12);}
    button.danger{color:#ffd7dc;border-color:#5a2731;background:rgba(176,0,32,.16);}
    button.small{padding:7px 10px;border-radius:12px;font-size:12px;box-shadow:none;font-weight:900}
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .muted{color:var(--muted);font-size:12px;margin-top:8px}
    .toast{margin-top:10px;font-size:13px;color:#9cf08a;display:none;font-weight:900}
    .toast.err{color:#ff8b97}

    table{
      width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,.03);
      border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);
    }
    thead th{background:rgba(255,255,255,.02);position:sticky;top:0;z-index:2;text-align:center;}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px;font-size:14px;vertical-align:top;white-space:nowrap;text-align:center;color:#e7e7ea;}
    th{font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:#cfd1da;position:relative;}
    th::after{content:"";position:absolute;left:0;bottom:0;width:100%;height:3px;background:linear-gradient(90deg, rgba(54,124,43,.95), rgba(255,222,0,.75));opacity:.95;}
    tbody tr:nth-child(odd){background:rgba(255,255,255,.01)}
    tbody tr:hover{background:rgba(54,124,43,.10)}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    .cell-input{
      min-width:120px;padding:7px 10px;border-radius:12px;border:1px solid var(--border-strong);
      background:rgba(255,255,255,.03);color:var(--text);text-align:center;
    }
    .w220{min-width:220px}
    .w200{min-width:200px}
    .w160{min-width:160px}
    .w140{min-width:140px}
    .w110{min-width:110px}

    .attachBox{display:flex;flex-direction:column;gap:6px;align-items:center}
    .attachList{display:flex;flex-direction:column;gap:6px;align-items:flex-start;max-width:320px}
    .attachItem{
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      padding:6px 10px;border-radius:12px;
      max-width:320px;
    }
    .attachItem a{
      color:#d7f7cf;text-decoration:none;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .attachMeta{font-size:11px;color:var(--muted)}
    .attachDel{padding:5px 8px;border-radius:10px}

    .footer{
      position:fixed;left:16px;bottom:12px;font-size:12px;color:#e7e7ea;background:rgba(0,0,0,.45);
      border:1px solid var(--border);border-left:7px solid var(--jd-green);
      padding:9px 12px;border-radius:14px;box-shadow:var(--shadow2);backdrop-filter:blur(6px);
    }
    .footer b{color:var(--jd-green)}
  </style>
</head>

<body>
  <div class="topbar">
    <h1 class="title"><span class="brandDot"></span> Carga de datos</h1>
    <div class="subpill">Estilo <b>Interagrovial</b> ¬∑ verde/amarillo</div>
  </div>

  <!-- FILTROS + EXPORT -->
  <div class="card">
    <div class="accentBar"></div>
    <div class="cardHeader">
      <h3>Filtros</h3>
      <div class="row" style="gap:8px">
        <button id="exportBtn" class="primary" type="button">Descargar Excel</button>
        <button id="clearFiltersBtn" class="secondary" type="button">Limpiar filtros</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Buscar (cualquier campo)</label>
        <input id="q" class="w220" placeholder="Ej: 12004566 / AGRO / 88855"/>
      </div>

      <div>
        <label>Divisi√≥n</label>
        <select id="fDivision">
          <option value="">(Todas)</option>
        </select>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="fCond">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="fWis">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Cierre de carpeta</label>
        <select id="fCierre">
          <option value="">(Todas)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Fecha estimada desde</label>
        <input id="fDateFrom" type="date"/>
      </div>

      <div>
        <label>Fecha estimada hasta</label>
        <input id="fDateTo" type="date"/>
      </div>
    </div>

    <div class="muted">Los filtros se aplican autom√°ticamente. La descarga exporta lo filtrado (CSV para Excel).</div>
  </div>

  <!-- FORMULARIO AGREGAR -->
  <div class="card">
    <div class="accentBar"></div>
    <h3>Agregar fila</h3>

    <div class="row">
      <div>
        <label>Factura</label>
        <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
      </div>

      <div>
        <label>Divisi√≥n</label>
        <input id="division" class="w200" placeholder="Ej: AGRO"/>
      </div>

      <div>
        <label>Transporte</label>
        <input id="transporte" class="w200" placeholder="Ej: Barco / Avi√≥n"/>
      </div>

      <div>
        <label>Carpeta</label>
        <input id="carpeta" class="w140" placeholder="Ej: 88855"/>
      </div>

      <div>
        <label>Fecha estimada</label>
        <input id="fecha_estimada" type="date" />
      </div>

      <div>
        <label>Orden de compra</label>
        <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="cond">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="wis">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Cierre de carpeta</label>
        <select id="cierre">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Adjuntos (pueden ser 1 o m√°s)</label>
        <input id="adjuntos" type="file" multiple />
        <div class="muted">Se suben a Firebase Storage. Luego pod√©s borrar 1 o varios sin borrar la fila.</div>
      </div>

      <button id="addBtn" class="primary" type="button">Agregar</button>
    </div>

    <div id="msg" class="muted"></div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>Fecha carga</th>
        <th>Factura</th>
        <th>Divisi√≥n</th>
        <th>Transporte</th>
        <th>Carpeta</th>
        <th>Fecha estimada</th>
        <th>Orden compra</th>
        <th>Condiciones</th>
        <th>WIS</th>
        <th>Cierre carpeta</th>
        <th>Adjuntos</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer"><b>INTERAGROVIAL S.A</b></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc,
      serverTimestamp, query, orderBy, onSnapshot, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // ‚úÖ PEGAR TU CONFIG REAL
    const firebaseConfig = {
      apiKey: "PEGAR_TU_API_KEY",
      authDomain: "PEGAR_TU_AUTH_DOMAIN",
      projectId: "PEGAR_TU_PROJECT_ID",
      storageBucket: "PEGAR_TU_STORAGE_BUCKET",
      messagingSenderId: "PEGAR_TU_SENDER_ID",
      appId: "PEGAR_TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const $ = (id) => document.getElementById(id);
    const tbody = $("tbody");
    const msgEl = $("msg");
    const toastEl = $("toast");
    const addBtn = $("addBtn");

    let editingRowId = null;
    let cache = [];
    let view = [];

    function showToast(text, isError=false){
      toastEl.textContent = text;
      toastEl.classList.toggle("err", isError);
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 2500);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function clearAddForm() {
      $("factura").value = "";
      $("division").value = "";
      $("transporte").value = "";
      $("carpeta").value = "";
      $("fecha_estimada").value = "";
      $("oc").value = "";
      $("cond").value = "SI";
      $("wis").value = "SI";
      $("cierre").value = "SI";
      $("adjuntos").value = "";
    }

    function withTimeout(promise, ms, timeoutMsg="Tiempo de espera agotado") {
      let t;
      const timeout = new Promise((_, rej) => { t = setTimeout(() => rej(new Error(timeoutMsg)), ms); });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
    function matchesText(row, q){
      if (!q) return true;
      const hay = [
        row.factura, row.division, row.transporte, row.carpeta,
        row.fecha_estimada, row.oc, row.cond, row.wis, row.cierre
      ].map(norm).join(" | ");
      return hay.includes(q);
    }
    function inDateRange(row, from, to){
      const d = row.fecha_estimada || "";
      if (!from && !to) return true;
      if (!d) return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function applyFilters(){
      const q = norm($("q").value);
      const fDivision = $("fDivision").value;
      const fCond = $("fCond").value;
      const fWis = $("fWis").value;
      const fCierre = $("fCierre").value;
      const from = $("fDateFrom").value || "";
      const to = $("fDateTo").value || "";

      view = cache.filter(x => {
        const r = x.data;
        if (fDivision && (r.division || "") !== fDivision) return false;
        if (fCond && (r.cond || "") !== fCond) return false;
        if (fWis && (r.wis || "") !== fWis) return false;
        if (fCierre && (r.cierre || "") !== fCierre) return false;
        if (!matchesText(r, q)) return false;
        if (!inDateRange(r, from, to)) return false;
        return true;
      });

      draw();
    }

    function rebuildDivisionOptions(){
      const sel = $("fDivision");
      const current = sel.value;
      const values = Array.from(new Set(cache.map(x => (x.data.division || "").trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">(Todas)</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      if (values.includes(current)) sel.value = current;
    }

    ["q","fDivision","fCond","fWis","fCierre","fDateFrom","fDateTo"].forEach(id=>{
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("clearFiltersBtn").addEventListener("click", ()=>{
      $("q").value = "";
      $("fDivision").value = "";
      $("fCond").value = "";
      $("fWis").value = "";
      $("fCierre").value = "";
      $("fDateFrom").value = "";
      $("fDateTo").value = "";
      applyFilters();
    });

    // ---- Export CSV ----
    function csvEscape(value){
      const s = (value ?? "").toString();
      const mustQuote = /[",\n\r;]/.test(s);
      const escaped = s.replaceAll('"','""');
      return mustQuote ? `"${escaped}"` : escaped;
    }

    function toCsv(rows){
      const headers = [
        "Fecha carga","Factura","Divisi√≥n","Transporte","Carpeta",
        "Fecha estimada","Orden compra","Condiciones","WIS","Cierre carpeta","Adjuntos (cant.)"
      ];
      const lines = [headers.map(csvEscape).join(",")];

      rows.forEach(x=>{
        const r = x.data;
        const dt = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "";
        const line = [
          dt,
          r.factura || "",
          r.division || "",
          r.transporte || "",
          r.carpeta || "",
          r.fecha_estimada || "",
          r.oc || "",
          r.cond || "",
          r.wis || "",
          r.cierre || "",
          (r.adjuntos?.length ?? 0).toString()
        ].map(csvEscape).join(",");
        lines.push(line);
      });

      return lines.join("\n");
    }

    function downloadCsv(filename, csv){
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("exportBtn").addEventListener("click", ()=>{
      const rows = (view.length ? view : cache);
      const csv = toCsv(rows);
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
      downloadCsv(`interagrovial_carga_${stamp}.csv`, csv);
      showToast("Descarga lista (CSV para Excel)");
    });

    // ---- Adjuntos helpers ----
    function safeFileName(name){
      return name.replace(/[^\w.\-()\s]/g, "_");
    }
    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }
    function fmtSize(bytes){
      if (!bytes && bytes !== 0) return "";
      const u = ["B","KB","MB","GB"];
      let i=0, b=bytes;
      while (b >= 1024 && i < u.length-1){ b/=1024; i++; }
      return `${b.toFixed(i===0?0:1)} ${u[i]}`;
    }

    async function uploadAttachmentsForRow(rowId, fileList){
      const files = Array.from(fileList || []);
      if (!files.length) return [];

      const out = [];
      for (const file of files){
        const clean = safeFileName(file.name);
        const path = `rows/${rowId}/${uid()}__${clean}`;
        const r = sRef(storage, path);

        await uploadBytes(r, file);
        const url = await getDownloadURL(r);

        out.push({
          name: file.name,
          path,
          url,
          size: file.size,
          uploadedAt: new Date().toISOString()
        });
      }
      return out;
    }

    async function deleteAttachment(rowId, att){
      // borrar archivo en Storage + sacar del array en Firestore
      if (!att?.path) throw new Error("Adjunto sin path");
      await deleteObject(sRef(storage, att.path));

      // recargar doc, filtrar, actualizar
      const refDoc = doc(db, "rows", rowId);
      const snap = await getDoc(refDoc);
      if (!snap.exists()) return;

      const cur = snap.data()?.adjuntos || [];
      const next = cur.filter(x => x.path !== att.path);
      await updateDoc(refDoc, { adjuntos: next, updatedAt: serverTimestamp() });
    }

    function renderAttachmentsCell(id, adjuntos){
      const arr = Array.isArray(adjuntos) ? adjuntos : [];
      if (!arr.length) return `<div class="attachMeta">Sin adjuntos</div>`;

      return `
        <div class="attachBox">
          <div class="attachList">
            ${arr.map((a, idx) => `
              <div class="attachItem">
                <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener">${escapeHtml(a.name || ("Adjunto " + (idx+1)))}</a>
                <span class="attachMeta">${escapeHtml(fmtSize(a.size))}</span>
                <button class="small danger attachDel" data-action="del-attach" data-path="${escapeHtml(a.path)}">üóë</button>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    // ---- CRUD ----
    addBtn.addEventListener("click", async () => {
      const files = $("adjuntos").files;

      const data = {
        factura: $("factura").value.trim(),
        division: $("division").value.trim(),
        transporte: $("transporte").value.trim(),
        carpeta: $("carpeta").value.trim(),
        fecha_estimada: $("fecha_estimada").value || "",
        oc: $("oc").value.trim(),
        cond: $("cond").value,
        wis: $("wis").value,
        cierre: $("cierre").value,
        adjuntos: [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const empty =
        !data.factura && !data.division && !data.transporte && !data.carpeta &&
        !data.fecha_estimada && !data.oc && (!files || files.length === 0);

      if (empty) { alert("Ingres√° al menos un dato o adjunt√° un archivo."); return; }

      try {
        msgEl.textContent = "Guardando...";
        addBtn.disabled = true;

        // 1) creo doc
        const ref = await withTimeout(addDoc(collection(db, "rows"), data), 15000);

        // 2) subo adjuntos (si hay) y actualizo doc
        if (files && files.length){
          msgEl.textContent = "Subiendo adjuntos...";
          const uploaded = await withTimeout(uploadAttachmentsForRow(ref.id, files), 60000, "Subida lenta.");
          if (uploaded.length){
            await withTimeout(updateDoc(doc(db, "rows", ref.id), {
              adjuntos: uploaded,
              updatedAt: serverTimestamp()
            }), 15000);
          }
        }

        msgEl.textContent = "";
        clearAddForm();
        showToast("Agregado con √©xito");
      } catch (e) {
        console.error(e);
        msgEl.textContent = "";
        showToast("No se pudo guardar/subir", true);
        alert("No se pudo guardar o subir adjuntos. Revis√° reglas/permisos o la red.");
      } finally {
        addBtn.disabled = false;
      }
    });

    function renderRow(id, r) {
      const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      const dtTxt = dt ? dt.toLocaleString() : "";
      const isEditing = (editingRowId === id);

      if (!isEditing) {
        return `
          <tr data-id="${id}">
            <td>${escapeHtml(dtTxt)}</td>
            <td>${escapeHtml(r.factura)}</td>
            <td>${escapeHtml(r.division)}</td>
            <td>${escapeHtml(r.transporte)}</td>
            <td>${escapeHtml(r.carpeta)}</td>
            <td>${escapeHtml(r.fecha_estimada)}</td>
            <td>${escapeHtml(r.oc)}</td>
            <td>${escapeHtml(r.cond)}</td>
            <td>${escapeHtml(r.wis)}</td>
            <td>${escapeHtml(r.cierre)}</td>
            <td>${renderAttachmentsCell(id, r.adjuntos)}</td>
            <td>
              <div class="actions">
                <button class="small secondary" data-action="edit">Editar</button>
                <button class="small danger" data-action="delete">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }

      const factura = escapeHtml(r.factura || "");
      const division = escapeHtml(r.division || "");
      const transporte = escapeHtml(r.transporte || "");
      const carpeta = escapeHtml(r.carpeta || "");
      const fecha_estimada = escapeHtml(r.fecha_estimada || "");
      const oc = escapeHtml(r.oc || "");
      const cond = r.cond || "SI";
      const wis = r.wis || "SI";
      const cierre = r.cierre || "SI";

      return `
        <tr data-id="${id}">
          <td>${escapeHtml(dtTxt)}</td>

          <td><input class="cell-input w140" data-field="factura" value="${factura}"></td>
          <td><input class="cell-input w200" data-field="division" value="${division}"></td>
          <td><input class="cell-input w200" data-field="transporte" value="${transporte}"></td>
          <td><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></td>
          <td><input class="cell-input w160" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></td>
          <td><input class="cell-input w140" data-field="oc" value="${oc}"></td>

          <td>
            <select class="cell-input w110" data-field="cond">
              <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <select class="cell-input w110" data-field="wis">
              <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <select class="cell-input w110" data-field="cierre">
              <option value="SI" ${cierre==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cierre==="NO" ? "selected" : ""}>NO</option>
            </select>
          </td>

          <td>
            <div class="attachBox">
              ${renderAttachmentsCell(id, r.adjuntos)}
              <div style="margin-top:8px">
                <input type="file" class="cell-input w220" data-add-files multiple />
                <div class="attachMeta">Pod√©s agregar m√°s adjuntos y luego ‚ÄúGuardar‚Äù.</div>
              </div>
            </div>
          </td>

          <td>
            <div class="actions">
              <button class="small primary" data-action="save">Guardar</button>
              <button class="small" data-action="cancel">Cancelar</button>
              <button class="small danger" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    function draw() {
      const dataToDraw = (view.length ? view : cache);
      tbody.innerHTML = dataToDraw.map(x => renderRow(x.id, x.data)).join("");
    }

    // ---- Auth an√≥nimo (no pide nada, pero habilita reglas seguras) ----
    async function ensureAnonAuth(){
      try{
        if (!auth.currentUser) await signInAnonymously(auth);
      }catch(e){
        console.error(e);
        showToast("No se pudo iniciar auth an√≥nima", true);
      }
    }
    onAuthStateChanged(auth, () => { /* noop */ });
    await ensureAnonAuth();

    // Listener en tiempo real
    const qSnap = query(collection(db, "rows"), orderBy("createdAt", "desc"));
    onSnapshot(qSnap, (snap) => {
      cache = [];
      snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
      rebuildDivisionOptions();
      applyFilters();
    }, (err) => {
      console.error(err);
      showToast("No se pudo leer Firestore", true);
    });

    // Acciones tabla
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit") { editingRowId = id; draw(); return; }
      if (action === "cancel") { editingRowId = null; draw(); return; }

      if (action === "del-attach") {
        // borrar solo 1 adjunto
        const path = btn.dataset.path;
        if (!path) return;
        if (!confirm("¬øEliminar este adjunto?")) return;

        try{
          btn.disabled = true;
          await ensureAnonAuth();
          await withTimeout(deleteAttachment(id, { path }), 30000, "Borrado lento.");
          showToast("Adjunto eliminado");
        }catch(err){
          console.error(err);
          showToast("No se pudo eliminar adjunto", true);
          alert("No se pudo eliminar el adjunto. Revis√° reglas/permisos o red.");
        }finally{
          btn.disabled = false;
        }
        return;
      }

      if (action === "save") {
        const fields = tr.querySelectorAll("[data-field]");
        const updated = {};
        fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());

        updated.cond = updated.cond === "NO" ? "NO" : "SI";
        updated.wis  = updated.wis  === "NO" ? "NO" : "SI";
        updated.cierre = updated.cierre === "NO" ? "NO" : "SI";

        const empty =
          !updated.factura && !updated.division && !updated.transporte && !updated.carpeta &&
          !updated.fecha_estimada && !updated.oc;

        if (empty) { alert("La fila no puede quedar vac√≠a."); return; }

        // adjuntos nuevos en modo edici√≥n (si agregan)
        const fileInput = tr.querySelector("[data-add-files]");
        const newFiles = fileInput?.files;

        try {
          btn.disabled = true;
          await ensureAnonAuth();

          // 1) update campos
          await withTimeout(updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() }), 15000);

          // 2) subir nuevos adjuntos y mergear al array
          if (newFiles && newFiles.length){
            const uploaded = await withTimeout(uploadAttachmentsForRow(id, newFiles), 60000, "Subida lenta.");
            if (uploaded.length){
              // arrayUnion funciona item por item, lo hacemos as√≠:
              for (const a of uploaded){
                await updateDoc(doc(db, "rows", id), { adjuntos: arrayUnion(a), updatedAt: serverTimestamp() });
              }
            }
          }

          editingRowId = null;
          showToast("Modificado con √©xito");
          applyFilters();
        } catch (err) {
          console.error(err);
          showToast("No se pudo modificar", true);
          alert("No se pudo modificar. Revis√° reglas/permisos o red.");
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delete") {
        if (!confirm("¬øSeguro que quer√©s eliminar esta fila? (Tambi√©n borra adjuntos)")) return;

        try {
          btn.disabled = true;
          await ensureAnonAuth();

          // 1) borrar adjuntos primero (si hay)
          const row = cache.find(x => x.id === id)?.data;
          const adj = Array.isArray(row?.adjuntos) ? row.adjuntos : [];
          for (const a of adj){
            if (a?.path){
              try{ await deleteObject(sRef(storage, a.path)); } catch(e){ /* no frenar por uno */ }
            }
          }

          // 2) borrar doc
          await withTimeout(deleteDoc(doc(db, "rows", id)), 15000);
          if (editingRowId === id) editingRowId = null;
          showToast("Eliminado con √©xito");
        } catch (err) {
          console.error(err);
          showToast("No se pudo eliminar", true);
          alert("No se pudo eliminar. Revis√° reglas/permisos o red.");
        } finally {
          btn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>
